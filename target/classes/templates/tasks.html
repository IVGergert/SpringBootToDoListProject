<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>–ú–µ–Ω–µ–¥–∂–µ—Ä –∑–∞–¥–∞—á</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="/js/taskScript.js" defer></script>
</head>
<body th:attr="data-open-profile=${openProfile}">
<div class="container">
    <header>
        <h1>üìã –ú–µ–Ω–µ–¥–∂–µ—Ä –∑–∞–¥–∞—á</h1>
        <div class="profile-btn">
            <button onclick="openProfilePopup()">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
        </div>
    </header>

    <div class="notification-area">
        <div th:if="${param.taskAdded}" class="success-message">–ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞!</div>
        <div th:if="${param.taskUpdated}" class="success-message">–ó–∞–¥–∞—á–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!</div>
        <div th:if="${param.taskDeleted}" class="success-message">–ó–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞!</div>
    </div>

    <div class="search-bar">
        <input type="text" id="searchInput" placeholder="üîç –ü–æ–∏—Å–∫ –∑–∞–¥–∞—á..." onkeyup="filterTasks()">
    </div>

    <div class="filters">
        <button onclick="showAllTasks()">–í—Å–µ</button>
        <button onclick="showCompleted()">–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
        <button onclick="showNotCompleted()">–ù–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
    </div>

    <form class="task-form" th:action="@{/tasks/add}" method="post">
        <input type="text" name="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" required>
        <input type="text" name="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" required>
        <input type="datetime-local" name="deadline" required>
        <button type="submit">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
    </form>

    <div class="task-list">
        <div th:each="task : ${tasks}" th:if="${task != null and !task.completed}"
             class="task-card" th:id="'task-' + ${task.id}">
            <h3 th:text="${task.name}">–ó–∞–¥–∞—á–∞</h3>
            <p th:text="${task.description}">–û–ø–∏—Å–∞–Ω–∏–µ</p>
            <p>üìÖ –°–æ–∑–¥–∞–Ω–æ: <span th:text="${#temporals.format(task.createdAt, 'dd-MM-yyyy HH:mm')}"></span></p>
            <p>‚è∞ –î–µ–¥–ª–∞–π–Ω: <span th:text="${#temporals.format(task.deadline, 'dd-MM-yyyy HH:mm')}"></span></p>

            <div class="task-actions">
                <form th:action="@{/tasks/toggle/{id}(id=${task.id})}" method="get">
                    <button type="submit" class="btn complete">‚úî –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
                </form>
                <button type="button" class="btn edit"
                        th:attr="data-task-id=${task.id},
                                 data-task-name=${task.name},
                                 data-task-description=${task.description},
                                 data-task-deadline=${#temporals.format(task.deadline, 'yyyy-MM-dd''T''HH:mm')}"
                        onclick="openEditPopup(this)">‚úè –ò–∑–º–µ–Ω–∏—Ç—å</button>
                <form th:action="@{/tasks/delete/{id}(id=${task.id})}" method="get">
                    <button type="submit" class="btn delete">üóë –£–¥–∞–ª–∏—Ç—å</button>
                </form>
            </div>
        </div>

        <!-- –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ -->
        <div th:each="task : ${tasks}" th:if="${task != null and task.completed}"
             class="task-card completed" th:id="'task-' + ${task.id}">
            <h3 th:text="${task.name}" class="strikethrough">–ó–∞–¥–∞—á–∞</h3>
            <p th:text="${task.description}" class="strikethrough">–û–ø–∏—Å–∞–Ω–∏–µ</p>
            <p>üìÖ –°–æ–∑–¥–∞–Ω–æ: <span th:text="${#temporals.format(task.createdAt, 'dd-MM-yyyy HH:mm')}"></span></p>
            <p>‚è∞ –î–µ–¥–ª–∞–π–Ω: <span th:text="${#temporals.format(task.deadline, 'dd-MM-yyyy HH:mm')}"></span></p>

            <div class="task-actions">
                <form th:action="@{/tasks/toggle/{id}(id=${task.id})}" method="get">
                    <button type="submit" class="btn complete">‚Ü© –í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å</button>
                </form>
                <button type="button" class="btn edit"
                        th:attr="data-task-id=${task.id},
                                 data-task-name=${task.name},
                                 data-task-description=${task.description},
                                 data-task-deadline=${#temporals.format(task.deadline, 'yyyy-MM-dd''T''HH:mm')}"
                        onclick="openEditPopup(this)">‚úè –ò–∑–º–µ–Ω–∏—Ç—å</button>
                <form th:action="@{/tasks/delete/{id}(id=${task.id})}" method="get">
                    <button type="submit" class="btn delete">üóë –£–¥–∞–ª–∏—Ç—å</button>
                </form>
            </div>
        </div>
    </div>

    <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
    <div id="profilePopup" class="popup-overlay hidden">
        <div class="popup-card">
            <button class="close-btn" onclick="closeProfilePopup()">√ó</button>
            <h2>üë§ –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>

            <div th:if="${profileError}" class="error-message" th:text="${profileError}"></div>
            <div th:if="${profileUpdated}" class="success-message" th:text="'–ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!'"></div>

            <form id="profileForm" th:action="@{/profile/update/{id}(id=${user.id})}" method="post">
                <input type="hidden" name="id" th:value="${user.id}">
                <label>–ò–º—è</label>
                <input type="text" name="name" th:value="${user.name}" required>
                <label>–§–∞–º–∏–ª–∏—è</label>
                <input type="text" name="surname" th:value="${user.surname}" required>
                <label>–û—Ç—á–µ—Å—Ç–≤–æ</label>
                <input type="text" name="patronymic" th:value="${user.patronymic}">
                <label>Email</label>
                <input type="email" name="email" th:value="${user.email}" required>
                <label>–ü–∞—Ä–æ–ª—å</label>
                <input type="password" name="password" placeholder="‚óè‚óè‚óè‚óè‚óè‚óè‚óè‚óè">
                <div class="profile-actions">
                    <button type="submit" class="save-btn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" class="cancel-btn" onclick="closeProfilePopup()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
            <form th:action="@{/logout}" method="post">
                <button type="submit" class="logout-btn">üö™ –í—ã–π—Ç–∏</button>
            </form>
        </div>
    </div>

    <!-- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ -->
    <div id="editTaskPopup" class="popup-overlay hidden">
        <div class="popup-card">
            <button class="close-btn" onclick="closeEditPopup()">√ó</button>
            <h2>‚úè –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É</h2>
            <form id="editTaskForm" method="post">
                <input type="hidden" name="id" id="editTaskId">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</label>
                <input type="text" name="name" id="editTaskName" required>
                <label>–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</label>
                <input type="text" name="description" id="editTaskDescription" required>
                <label>Deadline</label>
                <input type="datetime-local" name="deadline" id="editTaskDeadline" required>
                <div class="profile-actions">
                    <button type="submit" class="save-btn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" class="cancel-btn" onclick="closeEditPopup()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>
</div>
</body>
</html>
